import{b as te,r as a,a as ae,c as f,j as e,H as re}from"./app-ixndsVVo.js";import{A as se}from"./AdminLayout-DEfAXfXn.js";import{F as le,C as ne,B as oe,D as ie,P as ce}from"./Pagination-C2_dgWVT.js";import{C as L}from"./ConfirmationModal-dBfYQuSA.js";import{P as de}from"./PrimaryButton-Q6V_WmuN.js";import{e as $,f as ue,g as me,h as he,i as ge,d as pe,j as xe}from"./index-BH6x7HeI.js";import{r as be}from"./index-BA5a8Z8h.js";import"./Checkbox-EJWnnqVA.js";const fe=({trigger:n,children:l,position:i="bottom-right"})=>{const[d,c]=a.useState({top:0,left:0,width:0}),g=a.useRef(null),[v,m]=a.useState(!1),_=()=>{if(g.current){const p=g.current.getBoundingClientRect();c({top:p.bottom+window.scrollY,left:p.left+window.scrollX,width:p.width})}},w=()=>{switch(i){case"bottom-left":return"origin-top-left left-0";case"bottom-right":return"origin-top-right right-0";default:return"origin-top-right right-0"}};return e.jsxs(e.Fragment,{children:[e.jsx("div",{ref:g,onClick:()=>{_(),m(!0)},children:n}),v&&be.createPortal(e.jsx("div",{className:"fixed inset-0 z-50",onClick:()=>m(!1),children:e.jsx("div",{className:`absolute mt-1 w-48 rounded-md shadow-lg bg-neutral-50 dark:bg-neutral-800 ring-1 ring-primary-500 ring-opacity-20 focus:outline-none ${w()}`,style:{top:d.top,left:i==="bottom-right"?"auto":d.left,right:i==="bottom-right"?window.innerWidth-d.left-d.width:"auto",zIndex:9999},onClick:p=>p.stopPropagation(),children:l})}),document.body)]})},ke=({auditTrail:n,onView:l,onDelete:i,canManage:d})=>{const c=e.jsx("button",{className:"inline-flex justify-center w-full p-2 text-sm font-medium text-primary-600 dark:text-primary-400 bg-neutral-50 dark:bg-neutral-800 rounded-md hover:bg-primary-50 dark:hover:bg-neutral-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500",children:e.jsx(xe,{className:"h-4 w-4","aria-hidden":"true"})});return e.jsx(fe,{trigger:c,position:"bottom-right",children:e.jsxs("div",{className:"py-1",children:[e.jsxs("button",{onClick:l,className:"group flex items-center w-full px-4 py-2 text-sm text-neutral-700 dark:text-neutral-300 hover:bg-primary-50 dark:hover:bg-neutral-700 hover:text-primary-600 dark:hover:text-primary-400",children:[e.jsx(ge,{className:"mr-3 h-4 w-4","aria-hidden":"true"}),"Lihat"]}),d&&e.jsxs("button",{onClick:i,className:"group flex items-center w-full px-4 py-2 text-sm text-error-600 dark:text-error-400 hover:bg-error-50 dark:hover:bg-error-900/30 hover:text-error-700 dark:hover:text-error-300",children:[e.jsx(pe,{className:"mr-3 h-4 w-4","aria-hidden":"true"}),"Hapus"]})]})})},je=({isOpen:n,onClose:l,onConfirm:i,days:d,setDays:c})=>e.jsx(L,{isOpen:n,onClose:l,onConfirm:i,title:"Konfirmasi Pembersihan Log",message:e.jsxs("div",{children:[e.jsx("p",{className:"mb-4",children:"Masukkan jumlah hari untuk menghapus log audit trail yang lebih lama dari periode tersebut. Biarkan kosong untuk menghapus semua log."}),e.jsx("input",{type:"number",value:d,onChange:g=>c(g.target.value===""?"":Number(g.target.value)),min:"0",placeholder:"Jumlah hari (opsional)",className:"w-full rounded-md border border-neutral-300 dark:border-neutral-600 bg-white dark:bg-neutral-800 text-neutral-900 dark:text-neutral-100 focus:border-primary-500 focus:ring focus:ring-primary-500 focus:ring-opacity-50"})]}),confirmText:"Bersihkan Log",cancelText:"Batal"}),ve=(n=[])=>{const[l,i]=a.useState(()=>{try{const c=sessionStorage.getItem("selectedAuditTrails");return c?JSON.parse(c):n}catch{return n}});a.useEffect(()=>{sessionStorage.setItem("selectedAuditTrails",JSON.stringify(l))},[l]);const d=a.useCallback(()=>{sessionStorage.removeItem("selectedAuditTrails"),i([])},[]);return[l,i,d]};function Pe({auditTrails:n,filters:l,availableEvents:i,availableTables:d,auth:c}){const{props:g}=te(),v=g.flash||{},[m,_]=a.useState({isOpen:!1,auditTrailId:null,auditTrailDescription:""}),[w,p]=a.useState({isOpen:!1,count:0}),[A,B]=a.useState({isOpen:!1,days:""}),[o,k,C]=ve([]),[I,j]=a.useState(!1),[s,M]=a.useState({search:l?.search||"",event:l?.event||"",table:l?.table||"",date:l?.date||"",per_page:l?.per_page||10,sort:l?.sort||"created_at",direction:l?.direction||"desc"}),{success:x,error:b}=ae(),h=a.useRef({search:l?.search||"",event:l?.event||"",table:l?.table||"",date:l?.date||"",per_page:l?.per_page||10,sort:l?.sort||"created_at",direction:l?.direction||"desc"});a.useEffect(()=>{const t={search:s.search,event:s.event,table:s.table,date:s.date,per_page:s.per_page,sort:s.sort,direction:s.direction};if(t.search!==h.current.search||t.event!==h.current.event||t.table!==h.current.table||t.date!==h.current.date||t.per_page!==h.current.per_page||t.sort!==h.current.sort||t.direction!==h.current.direction){const u=setTimeout(()=>{f.get(route("admin.audit-trail.index"),t,{preserveState:!0,replace:!0,preserveScroll:!0,onFinish:()=>{h.current=t}})},500);return()=>clearTimeout(u)}},[s]),a.useEffect(()=>{if(n&&n.data&&o.length>0){const t=n.data.map(N=>N.id),r=t.every(N=>o.includes(N)),u=t.some(N=>o.includes(N));j(!!r)}else j(!1)},[n,o]);const H=a.useCallback(t=>{f.visit(route("admin.audit-trail.show",t.id))},[]),G=a.useCallback(()=>{if(n&&n.data){const t=n.data.map(r=>r.id);k(I?r=>r.filter(u=>!t.includes(u)):r=>[...new Set([...r,...t])])}},[I,n,k]),K=a.useCallback(t=>{k(r=>r.includes(t)?r.filter(u=>u!==t):[...r,t])},[k]),R=a.useCallback((t,r)=>{_({isOpen:!0,auditTrailId:t,auditTrailDescription:r})},[]),J=a.useCallback(()=>{p({isOpen:!0,count:o.length})},[o.length]),E=a.useCallback(()=>{B({isOpen:!0,days:""})},[]),y=a.useCallback(()=>{_({isOpen:!1,auditTrailId:null,auditTrailDescription:""})},[]),P=a.useCallback(()=>{p({isOpen:!1,count:0})},[]),D=a.useCallback(()=>{B({isOpen:!1,days:""})},[]),U=a.useCallback(()=>{m.auditTrailId?f.delete(route("admin.audit-trail.cleanup"),{days:0,id:m.auditTrailId},{onSuccess:()=>{x("Log audit trail berhasil dihapus!"),y(),k(t=>t.filter(r=>r!==m.auditTrailId))},onError:()=>{b("Gagal menghapus log audit trail."),y()}}):y()},[m.auditTrailId,y,x,b,k]),V=a.useCallback(()=>{o.length>0&&f.post(route("admin.audit-trail.cleanup"),{days:0,ids:o},{onSuccess:()=>{x(`${o.length} log audit trail berhasil dihapus!`),C(),j(!1),P()},onError:()=>{b("Gagal menghapus log audit trail terpilih."),P()}})},[o,P,x,b,C]),W=a.useCallback(()=>{f.post(route("admin.audit-trail.cleanup"),{days:A.days||null},{onSuccess:()=>{x("Pembersihan log audit trail berhasil!"),D(),C(),j(!1)},onError:()=>{b("Gagal melakukan pembersihan log audit trail."),D()}})},[A.days,D,x,b,C]),X=a.useCallback(()=>{f.post(route("admin.audit-trail.export"),{ids:o.length>0?o:null,start_date:s.date||null,event:s.event||null,table:s.table||null},{onSuccess:()=>{x("Ekspor data dimulai!")},onError:()=>{b("Gagal mengekspor data audit trail.")}})},[s,o,x,b]),T=a.useCallback(t=>{M(r=>({...r,sort:t,direction:r.sort===t&&r.direction==="asc"?"desc":"asc"}))},[]),z=a.useCallback(()=>{M({search:"",event:"",table:"",date:"",per_page:10,sort:"created_at",direction:"desc"}),f.get(route("admin.audit-trail.index"),{},{preserveState:!0,preserveScroll:!0,onSuccess:()=>{h.current={search:"",event:"",table:"",date:"",per_page:10,sort:"created_at",direction:"desc"}}})},[]),F=a.useCallback(t=>{M(r=>({...r,per_page:t}))},[]),S=a.useCallback((t,r)=>{M(u=>({...u,[t]:r}))},[]),O=a.useCallback(t=>s.sort!==t?e.jsx($,{className:"ml-1 h-4 w-4 opacity-50"}):s.direction==="asc"?e.jsx($,{className:"ml-1 h-4 w-4"}):e.jsx(ue,{className:"ml-1 h-4 w-4"}),[s.sort,s.direction]),Y=a.useMemo(()=>[{key:"event",label:"Peristiwa",sortable:!0,onSort:()=>T("event"),sortIcon:O("event"),render:t=>e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:`w-2 h-2 rounded-full mr-2 bg-${t.event_color}-500`}),e.jsx("div",{className:"text-sm font-medium text-neutral-900 dark:text-white",children:i[t.event]||t.event})]})},{key:"table_name",label:"Tabel",sortable:!0,onSort:()=>T("table_name"),sortIcon:O("table_name"),render:t=>e.jsx("div",{className:"text-sm text-neutral-900 dark:text-white",children:t.table_display_name})},{key:"user",label:"Pengguna",render:t=>e.jsx("div",{className:"text-sm text-neutral-900 dark:text-white",children:t.user?t.user.name:"Sistem"})},{key:"created_at",label:"Tanggal",sortable:!0,onSort:()=>T("created_at"),sortIcon:O("created_at"),render:t=>e.jsx("div",{className:"text-sm text-neutral-500 dark:text-neutral-400",children:new Date(t.created_at).toLocaleDateString("id-ID",{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})})}],[T,O,i]),q=a.useMemo(()=>e.jsxs("div",{className:"flex flex-col items-center justify-center text-neutral-400 dark:text-neutral-500",children:[e.jsx(me,{className:"h-12 w-12 mb-3 opacity-50"}),e.jsx("p",{className:"text-lg font-medium",children:"Tidak ada log audit trail"}),e.jsx("p",{className:"mt-1 text-sm",children:"Tidak ada aktivitas yang tercatat saat ini"})]}),[]),Q=a.useCallback(t=>e.jsx(ke,{auditTrail:t,onView:()=>f.visit(route("admin.audit-trail.show",t.id)),onDelete:()=>R(t.id,t.message),canManage:c.user.permissions.includes("manage audit trail")}),[R,c.user.permissions]),Z=a.useMemo(()=>e.jsx("div",{className:"mb-6",children:e.jsx(le,{searchTerm:s.search,onSearchChange:t=>S("search",t),perPage:s.per_page,onPerPageChange:F,onClearFilters:z,additionalFilters:e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-neutral-700 dark:text-neutral-300",children:"Peristiwa"}),e.jsxs("select",{value:s.event,onChange:t=>S("event",t.target.value),className:"mt-1 block w-full rounded-md border border-neutral-300 dark:border-neutral-600 bg-white dark:bg-neutral-800 text-neutral-900 dark:text-neutral-100 focus:border-primary-500 focus:ring focus:ring-primary-500 focus:ring-opacity-50",children:[e.jsx("option",{value:"",children:"Semua Peristiwa"}),Object.entries(i).map(([t,r])=>e.jsx("option",{value:t,children:r},t))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-neutral-700 dark:text-neutral-300",children:"Tabel"}),e.jsxs("select",{value:s.table,onChange:t=>S("table",t.target.value),className:"mt-1 block w-full rounded-md border border-neutral-300 dark:border-neutral-600 bg-white dark:bg-neutral-800 text-neutral-900 dark:text-neutral-100 focus:border-primary-500 focus:ring focus:ring-primary-500 focus:ring-opacity-50",children:[e.jsx("option",{value:"",children:"Semua Tabel"}),Object.entries(d).map(([t,r])=>e.jsx("option",{value:t,children:r},t))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-neutral-700 dark:text-neutral-300",children:"Tanggal"}),e.jsx("input",{type:"date",value:s.date,onChange:t=>S("date",t.target.value),className:"mt-1 block w-full rounded-md border border-neutral-300 dark:border-neutral-600 bg-white dark:bg-neutral-800 text-neutral-900 dark:text-neutral-100 focus:border-primary-500 focus:ring focus:ring-primary-500 focus:ring-opacity-50"})]})]})})}),[s.search,s.event,s.table,s.date,s.per_page,i,d,S,F,z]),ee=a.useMemo(()=>c.user.permissions.includes("manage audit trail")?e.jsxs(de,{onClick:E,className:"flex items-center bg-primary-600 hover:bg-primary-700 focus:ring-primary-500",children:[e.jsx(he,{className:"mr-2 h-5 w-5"}),"Bersihkan Log"]}):null,[E,c.user.permissions]);return e.jsxs(se,{title:"Manajemen Audit Trail",children:[e.jsx(re,{title:"Manajemen Audit Trail"}),e.jsx(L,{isOpen:m.isOpen,onClose:y,onConfirm:U,title:"Konfirmasi Penghapusan",message:`Apakah Anda yakin ingin menghapus log audit trail "${m.auditTrailDescription}"? Tindakan ini tidak dapat dibatalkan.`,confirmText:"Hapus Log",cancelText:"Batal"}),e.jsx(L,{isOpen:w.isOpen,onClose:P,onConfirm:V,title:"Konfirmasi Penghapusan Massal",message:`Apakah Anda yakin ingin menghapus ${w.count} log audit trail terpilih? Tindakan ini tidak dapat dibatalkan.`,confirmText:`Hapus ${w.count} Log`,cancelText:"Batal"}),e.jsx(je,{isOpen:A.isOpen,onClose:D,onConfirm:W,days:A.days,setDays:t=>B(r=>({...r,days:t}))}),e.jsxs(ne,{title:"Manajemen Audit Trail",description:"Kelola semua log aktivitas sistem",createButton:ee,filters:Z,children:[v.success&&e.jsx("div",{className:"mb-8 bg-success-50 dark:bg-success-900/30 border border-success-200 dark:border-success-800 rounded-md p-4",children:e.jsxs("div",{className:"flex",children:[e.jsx("div",{className:"flex-shrink-0",children:e.jsx("svg",{className:"h-5 w-5 text-success-400",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{fillRule:"evenodd",d:"M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z",clipRule:"evenodd"})})}),e.jsx("div",{className:"ml-3",children:e.jsx("p",{className:"text-sm font-medium text-success-800 dark:text-success-200",children:v.success})})]})}),v.error&&e.jsx("div",{className:"mb-8 bg-error-50 dark:bg-error-900/30 border border-error-200 dark:border-error-800 rounded-md p-4",children:e.jsxs("div",{className:"flex",children:[e.jsx("div",{className:"flex-shrink-0",children:e.jsx("svg",{className:"h-5 w-5 text-error-400",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{fillRule:"evenodd",d:"M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z",clipRule:"evenodd"})})}),e.jsx("div",{className:"ml-3",children:e.jsx("p",{className:"text-sm font-medium text-error-800 dark:text-error-200",children:v.error})})]})}),o.length>0&&e.jsx("div",{className:"mb-6",children:e.jsx(oe,{selectedCount:o.length,onBulkDelete:c.user.permissions.includes("manage audit trail")?J:null,onBulkExport:X,onClearSelected:()=>{C(),j(!1)}})}),e.jsx("div",{className:"mb-6",children:e.jsx(ie,{columns:Y,data:n?.data||[],selectedItems:o,onSelectItem:K,onSelectAll:G,selectAll:I,emptyState:q,rowActions:Q,keyField:"id",onRowClick:H})}),n&&n.data&&n.data.length>0&&n.links&&n.links.length>3&&e.jsx(ce,{data:n})]})]})}export{Pe as default};
